<!DOCTYPE html>
<html>
  <head>
    <meta charset='UTF-8'>
    <title>Sparse Matrix</title>
    <style>
      #board {
        display: flex;
        flex-wrap: wrap;
      }
      .sqrStyle {
        background-color: white;
        border-style: solid;
        border-left-color: white;
        border-right-color: white;
        border-top-color: white;
        border-bottom-color: white;
        transition-property: background-color;
        transition-duration: 0.5s;
      }
    </style>
  </head>
  <body>
    <h1>Sparse Matrix Dance</h1>
    <div id='board'></div>
  </body>
  <script type='module'>
    import { BOARD_TYPE } from './env.mjs';
    import { drawBoard, sqrId } from './modules/utilities.mjs';
    import { SQUARE_WIDE_PX, SQUARE_HIGH_PX, BORDER_WIDTH_PX, COLORS } from './modules/pieces.mjs';
    import { useBoard } from './modules/board.mjs';

    const { BOARD_WIDE_SQ, BOARD_HIGH_SQ, BOARD_WIDTH_PX } = useBoard(BOARD_TYPE || 'testing');

    const boards = [];
    const flashers = [];
    let solutionCount = 0;
    let myWorker;

    // Show status at this depth, should be from 0 to 11, 999 = never
    const EXPOLORE_AT_DEPTH = 999;

    function stringifyBoard(board) {
      return `\n${board.map(row => row.join(' ')).join('\n')}\n`;
    }

    function cbShowSolution(solution) {
      solutionCount += 1;
      console.log(`Solution #${solutionCount}: ${stringifyBoard(solution)}`);
      boards.push(solution);
    }

    function cbShowStatus(status, depth) {
      if (depth >= EXPOLORE_AT_DEPTH) {
        console.log(`Exploring at depth ${depth}: ${stringifyBoard(status)}`);
        boards.push(status);
      }
    }

    function cbFlash(row) {
      flashers.push(row.columns);
    }

    const flashInterval = setInterval(() => {
      if (flashers.length > 0) {
        const columns = flashers.pop();
        let theBackgroundColor = 'blue';
        columns.forEach(item => {
          const xy = item.split(',');
          if (xy.length === 2) {
            const el = document.getElementById(`sqr_${xy[0]}_${xy[1]}`);
            const originalBackgroundColor = el.style.backgroundColor;
            el.style.backgroundColor = theBackgroundColor;
            setTimeout(() => el.style.backgroundColor = originalBackgroundColor, 500);
          } else {
            theBackgroundColor = COLORS[item];
          }
        });
      } else {
        console.log('No more flashers');
        clearInterval(flashInterval);
      }
    }, 500);

    const interval = setInterval(() => {
      if (boards.length > 0) {
        drawBoard(boards.pop());
      } else {
        console.log('Done');
        if (myWorker) myWorker.terminate();
        clearInterval(interval);
      }
    }, 4000);

    // Create the board html
    const board = document.getElementById('board');
    board.style.width = `${BOARD_WIDTH_PX}px`;

    for (let y=0; y < BOARD_HIGH_SQ; y++) {
      for (let x=0; x < BOARD_WIDE_SQ; x++) {
        const div = document.createElement('div');
        div.id = sqrId(x, y);
        div.className = 'sqrStyle';
        div.style.width = `${SQUARE_WIDE_PX}px`;
        div.style.height = `${SQUARE_HIGH_PX}px`;
        div.style.borderWidth = `${BORDER_WIDTH_PX}px`;
        board.appendChild(div);
      }
    }

    if (window.Worker) {
      myWorker = new Worker( './worker.mjs', { type: 'module' } );

      myWorker.addEventListener('message', (e) => {
        switch(e.data.callback) {
          case('cbShowStatus'):
            const data = e.data.data;
            cbShowStatus(JSON.parse(data.status), data.depth);
            break;
          case('cbShowSolution'):
            cbShowSolution(JSON.parse(e.data.data));
            break;
          case('cbFlash'):
            cbFlash(JSON.parse(e.data.data));
            break;
          default:
            console.log('Uncaught message from worker, e:', e.data);
        }
      });

      myWorker.postMessage({ state: 'go' });
    } else {
      console.log(`Your browser doesn't support web workers.`);
    }
  </script>
</html>
